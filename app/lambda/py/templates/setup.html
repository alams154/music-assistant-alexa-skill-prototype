<!doctype html>
<html>
<head><meta charset="utf-8"><title>Skill Setup</title></head>
<body>
    <h1>Skill Setup</h1>
    <div>
        <div style="margin-bottom:8px;">Endpoint is read from container configuration (SKILL_HOSTNAME)</div>
        __CREDENTIALS_HTML__
        <div><button id="setup-start">Start Setup</button></div>
        <div id="auth-area" style="display:none;margin-top:8px">
            <div><a id="auth-link" href="#" target="_blank">Open authorization page</a></div>
            <div id="code-entry" style="display:none">
                <form id="code-form"><input id="auth-code" name="code" type="password" autocomplete="one-time-code"/><button>Submit Code</button></form>
                <div id="code-result"></div>
            </div>
        </div>
        <div style="margin-top:8px;font-weight:600">Setup Logs</div>
        <pre id="setup-logs" tabindex="0" style="max-height:300px;overflow:auto;background:#f6f6f6;padding:8px"></pre>
        <div style="margin-top:8px"><button id="download-logs">Download logs</button></div>
    </div>
    <script>
    const initialLogs = __INITIAL_LOGS__;
    const initialAuth = __INITIAL_AUTH__;
    const initialCreated = __INITIAL_CREATED__;
    (function(){
        const startBtn = document.getElementById('setup-start');
        const logsEl = document.getElementById('setup-logs');
        const authArea = document.getElementById('auth-area');
        const authLink = document.getElementById('auth-link');
        const codeEntry = document.getElementById('code-entry');
        const codeForm = document.getElementById('code-form');
        // Track whether we've already opened the auth URL in a tab/window
        let authOpened = false;
        const downloadBtn = document.getElementById('download-logs');

        function showStatusButton(){
            try{
                if(!document.getElementById('goto-status')){
                    const btn = document.createElement('button');
                    btn.id = 'goto-status';
                    btn.textContent = 'Open Status Page';
                    btn.style.marginLeft = '8px';
                    btn.addEventListener('click', function(){ window.location = '/status'; });
                    startBtn.parentNode.insertBefore(btn, startBtn.nextSibling);
                }
            }catch(e){/* ignore */}
        }

        function renderInitial(){
            // Render any initial logs/auth embedded in the page
            try{ logsEl.textContent = JSON.stringify(initialLogs || [], null, 2); logsEl.scrollTop = logsEl.scrollHeight; }catch(e){ logsEl.textContent = ''; }
            if(initialCreated){ showStatusButton(); return; }
            if(initialAuth){
                authArea.style.display='block';
                authLink.href = initialAuth;
                authLink.textContent = 'Open authorization page';
                codeEntry.style.display='block';
                if(!authOpened){ try{ window.open(initialAuth, '_blank'); authOpened = true; }catch(e){} }
            }
            // Start adaptive polling loop
            pollLogs();
        }

        // Make the logs box focusable and intercept Cmd/Ctrl+A to select only the logs
        logsEl.addEventListener('click', function(){ logsEl.focus(); });
        logsEl.addEventListener('keydown', function(e){
            const key = (e.key || '').toLowerCase();
            if ((e.ctrlKey || e.metaKey) && key === 'a'){
                e.preventDefault();
                try{
                    const range = document.createRange();
                    range.selectNodeContents(logsEl);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }catch(err){ /* ignore */ }
            }
        });

        function pollLogs(){
            fetch('/setup?format=json').then(r=>r.json()).then(j=>{
                try{ logsEl.textContent = JSON.stringify(j.logs || [], null, 2); logsEl.scrollTop = logsEl.scrollHeight; }catch(e){ logsEl.textContent = ''; }
                if(j.created){
                    // Show a button the user can click to go to the status page
                    try{ showStatusButton(); return; }catch(e){}
                }
                if(j.auth_url){
                    authArea.style.display='block';
                    authLink.href = j.auth_url;
                    authLink.textContent = 'Open authorization page';
                    codeEntry.style.display='block';
                    if(!authOpened){ try{ window.open(j.auth_url, '_blank'); authOpened = true; }catch(e){} }
                }
                // Schedule next poll: more frequent when active, otherwise back off
                const next = j.active ? 3000 : 15000;
                setTimeout(pollLogs, next);
            }).catch(()=>{ setTimeout(pollLogs, 15000); });
        }

        startBtn.addEventListener('click', function(){
            fetch('/setup/start', {method:'POST'}).then(async (r)=>{
                let j = {};
                try{ j = await r.json(); }catch(e){}
                if(!r.ok){ logsEl.textContent = (j.error || JSON.stringify(j) || 'Error starting setup'); }
                else { if(j.status === 'auth_started'){ authArea.style.display='block'; pollLogs(); } else { pollLogs(); } }
            }).catch(()=>{ logsEl.textContent = 'Start request failed'; });
        });

        downloadBtn.addEventListener('click', function(){
            // Navigate to download endpoint to trigger browser download
            window.location = '/setup/logs/download';
        });
        codeForm.addEventListener('submit', function(ev){
            ev.preventDefault();
            const codeInput = document.getElementById('auth-code');
            const code = codeInput.value.trim();
            if(!code) return;
            // Clear the input after submission so the code isn't left visible
            try{ codeInput.value = ''; }catch(e){}
            // Remove the code result div from the DOM (it's no longer needed)
            try{
                const resultEl = document.getElementById('code-result');
                if(resultEl && resultEl.parentNode){ resultEl.parentNode.removeChild(resultEl); }
            }catch(e){}
            fetch('/setup/code', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})}).then(r=>r.json()).then(j=>{
                // Do not persist the server response in the UI; hide inputs if creation started
                if(j.status === 'started'){ codeEntry.style.display='none'; }
                // kick the poll loop once immediately to refresh logs
                pollLogs();
            }).catch(()=>{
                // On error, recreate a small result element to show failure
                try{
                    let resultEl = document.getElementById('code-result');
                    if(!resultEl){ resultEl = document.createElement('div'); resultEl.id = 'code-result'; codeEntry.appendChild(resultEl); }
                    resultEl.textContent = 'Submit failed';
                }catch(e){}
            });
        });

        renderInitial();
    })();
    </script>
</body>
</html>
