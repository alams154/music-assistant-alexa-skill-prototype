name: Build and Push Docker image to GHCR

on:
  push:
    branches: [ master ]
    paths:
      - 'Dockerfile'
      - '.github/workflows/docker-ghcr.yml'
      - 'app/**'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute (local-only) version for image tag
        id: version
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          set -euo pipefail
          # Ensure VERSION exists
          if [ ! -f VERSION ]; then
            echo "0.0.1-beta" > VERSION
          fi
          current=$(cat VERSION)

          # Determine changed files between the pushed range
          BEFORE='${{ github.event.before }}'
          SHA='${{ github.sha }}'
          REF='${{ github.ref_name }}'

          # Fetch the ref so git diff works reliably
          git fetch origin "${REF}" --no-tags --prune -q || true

          if [ -z "${BEFORE}" ] || [ "${BEFORE}" = "0000000000000000000000000000000000000000" ]; then
            changed=$(git diff --name-only origin/${REF}..${SHA} || true)
          else
            changed=$(git diff --name-only ${BEFORE}..${SHA} || true)
          fi

          echo "Changed files:\n${changed}"

          # Decide whether changes require a new image. Match Dockerfile, app/, addons/, or files under .github/workflows that affect image builds.
          need_bump=false
          for f in ${changed}; do
            if [ -z "${f}" ]; then
              continue
            fi
            case "${f}" in
              Dockerfile|app/*|addons/*|.github/workflows/*)
                need_bump=true
                break
                ;;
            esac
          done

          # If run by the bot, don't alter behavior
          if [ "${GITHUB_ACTOR}" = "github-actions[bot]" ]; then
            new="${current}"
          else
            if [ "${need_bump}" = "true" ]; then
              core=${current%%-*}
              prerelease=""
              if [[ "${current}" == *"-"* ]]; then prerelease="-${current#*-}"; fi
              IFS='.' read -r major minor patch <<< "${core}"
              newpatch=$((patch + 1))
              new="${major}.${minor}.${newpatch}${prerelease}"
              # Write VERSION locally for this workflow (do NOT commit or push)
              echo "${new}" > VERSION
            else
              new="${current}"
            fi
          fi

          echo "current=${current}" >> $GITHUB_OUTPUT
          echo "new=${new}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ steps.version.outputs.new }}
        run: |
          TAG=${IMAGE_TAG}
          docker build -t ghcr.io/${{ github.repository_owner }}/music-assistant-skill:${TAG} -t ghcr.io/${{ github.repository_owner }}/music-assistant-skill:latest .

      - name: Push Docker image
        env:
          IMAGE_TAG: ${{ steps.version.outputs.new }}
        run: |
          TAG=${IMAGE_TAG}
          docker push ghcr.io/${{ github.repository_owner }}/music-assistant-skill:${TAG}
          docker push ghcr.io/${{ github.repository_owner }}/music-assistant-skill:latest